name: Reusable CD Workflow

on:
  workflow_dispatch: 
    inputs:
      namespace:
        required: true
        type: string
      image_name:
        required: true
        type: string
      version:
        required: true
        type: string
      chart:
        required: true
        type: string
      environment:
        description: Entorno de despliegue
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Descargar c√≥digo del repositorio
        uses: actions/checkout@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.30.0' 
        
      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
            version: "v0.30.0" 
              
      # - name: Checkout CI scripts repo
      #   uses: actions/checkout@v3
      #   with:
      #     repository: claudiatn/platform-ci-cd
      #     ref: main
      #     path: cd-scripts
          
      # - name: DEPLOY HELM
      #   id: deploy
      #   env:
      #     GHCR_PAT: ${{ secrets.GHCR_PAT }}
      #   run: |
      #     chmod +x cd-scripts/scripts/build_and_push.sh
      #     cd-scripts/scripts/build_and_push.sh \
      #       "${{ inputs.namespace }}" \
      #       "${{ inputs.environment }}" \
      #       "${{ github.actor }}" \
      #       "$GHCR_PAT" \
      #       "${{ inputs.chart }}" 

      
      - name: Checkout CI scripts repo
        uses: actions/checkout@v3
        with:
          repository: claudiatn/platform-ci-cd
          ref: main
          path: platform-ci-cd

      - name: Instalar Ansible y colecciones
        run: |
          python3 -m pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install kubernetes.core
          pip install kubernetes openshift

      - name: Debug environment
        run: |
          echo environment elegido: ${{ inputs.environment }}
          
      # - name: Ejecutar Ansible para desplegar Helm
      #   env:
      #     GHCR_PAT: ${{ secrets.GHCR_PAT }}
      #   run: |
      #     ansible-playbook \
      #       -i platform-ci-cd/ansible/inventory/hosts.yaml \
      #       platform-ci-cd/ansible/playbooks/deploy.yaml \
      #       -e namespace=${{ inputs.namespace }} \
      #       -e environment=${{ inputs.environment }} \
      #       -e actor=${{ github.actor }}  \
      #       -e ghcr_pat=$GHCR_PAT \
      #       -e chart=$chart \
      #       -e @platform-ci-cd/ansible/groups_vars/${{ inputs.environment }}.yaml
