name: Reusable CD Workflow

on:
  workflow_call:
    inputs:
      namespace:
        required: true
        type: string
      image_name:
        required: true
        type: string
      version:
        required: true
        type: string
      chart:
        required: true
        type: string
      environment:
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Descargar c√≥digo del repositorio
        uses: actions/checkout@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.30.0' 
        
      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
            version: "v0.30.0" 
              
      - name: Create namespace
        run: kubectl create namespace ${{ inputs.namespace }}

      - name: Crear ghcr-secret
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GHCR_PAT  }} \
            --namespace=${{ inputs.namespace }}


      - name: Instalar y desplegar con Helm
        run: |
               helm upgrade --install ${{ inputs.chart }} ./helm \
                --namespace ${{ inputs.namespace }}
                         
