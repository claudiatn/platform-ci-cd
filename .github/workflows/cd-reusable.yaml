name: Reusable CD Workflow

on:
  workflow_call: 
    inputs:
      namespace:
        required: true
        type: string
      image_name:
        required: true
        type: string
      version:
        required: true
        type: string
      chart:
        required: true
        type: string
      environment:
        description: Entorno de despliegue
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Descargar cÃ³digo del repositorio
        uses: actions/checkout@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.30.0' 
        
      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
            version: "v0.30.0" 
              
      # - name: Checkout CI scripts repo
      #   uses: actions/checkout@v3
      #   with:
      #     repository: claudiatn/platform-ci-cd
      #     ref: main
      #     path: cd-scripts
          
      # - name: DEPLOY HELM
      #   id: deploy
      #   env:
      #     GHCR_PAT: ${{ secrets.GHCR_PAT }}
      #   run: |
      #     chmod +x cd-scripts/scripts/build_and_push.sh
      #     cd-scripts/scripts/build_and_push.sh \
      #       "${{ inputs.namespace }}" \
      #       "${{ inputs.environment }}" \
      #       "${{ github.actor }}" \
      #       "$GHCR_PAT" \
      #       "${{ inputs.chart }}" 

      
      - name: Checkout CI scripts repo
        uses: actions/checkout@v3
        with:
          repository: claudiatn/platform-ci-cd
          ref: main
          path: platform-ci-cd

      - name: Instalar Ansible y colecciones
        run: |
          python3 -m pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install kubernetes.core
          pip install kubernetes openshift
      
      - name: Download image tag
        uses: actions/download-artifact@v4
        with:
          name: image-tag

      - name: Read tag
        id: read_tag
        run: echo "tag=$(cat artifact.txt)" >> $GITHUB_OUTPUT

          
      - name: Ejecutar Ansible para desplegar Helm
        env:
          IMAGE_TAG: ${{ steps.read_tag.outputs.tag }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        run: |
          ansible-playbook \
            -i platform-ci-cd/ansible/inventory/hosts.yaml \
            platform-ci-cd/ansible/playbooks/deploy.yaml \
            -e namespace=${{ inputs.namespace }} \
            -e deploy_environment=${{ inputs.environment }} \
            -e actor=${{ github.actor }}  \
            -e ghcr_pat=$GHCR_PAT \
            -e chart=${{ inputs.chart }} \
            -e image_tag=$IMAGE_TAG
   
